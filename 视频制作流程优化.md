# 音频先行的 AI 视频生产流程（主项目 Agent 实施规划）

> 目标：解决"生成视频片段时长短（常见 6–8s）导致长旁白/对白无法对齐"的结构性问题，把生产主时钟从视频端切到音频端，显著降低后期音画同步成本，提高片段良品率与可复用性。

---

## 整体架构设计

### 设计原则

1. **最小侵入性** - Agent 内部核心逻辑不动，只在外层添加前置约束
2. **关注点分离** - 音频编排作为独立模块，与视频生成解耦
3. **用户可控** - 用户在确认前可以手动调整切分点
4. **向后兼容** - 原有流程仍可用（不走编排直接生成）

### 新增模块：音频编辑工作台

```
┌─────────────────────────────────────────────────────────────────┐
│                   音频编辑工作台（新增独立模块）                    │
├─────────────────────────────────────────────────────────────────┤
│  脚本文本 → TTS生成 → 音频波形 → 切分编辑 → 确认                  │
│                          ↓                                      │
│              生成 audio_timeline（带 timecode 的镜头表）          │
└─────────────────────────────────────────────────────────────────┘
                           ↓ 用户确认
┌─────────────────────────────────────────────────────────────────┐
│                    Agent Pipeline（原有，不变）                   │
├─────────────────────────────────────────────────────────────────┤
│  元素生成 → 起始帧生成 → 视频生成                                 │
│      ↑_________↑___________↑                                    │
│           受 audio_timeline 约束                                 │
│         （镜头数、每镜头时长、切点）                               │
└─────────────────────────────────────────────────────────────────┘
```

### 核心思想

- **编辑工作台是外部模块**：在 AgentPage 中作为前置步骤
- **Agent 内部逻辑不变**：原有的 `execute_full_pipeline()` 保持不动
- **约束传递**：编辑工作台确认后生成 `audio_timeline`，作为约束参数传入 Pipeline
- **Pipeline 在约束下执行**：视频生成时读取 `audio_timeline` 中的时长/切点信息

---

## 1. 问题总结（现状缺陷）

### 1.1 当前主项目 Pipeline 流程

**代码位置**: `backend/services/agent_service.py:3784-3868` (`execute_full_pipeline`)

```
阶段1: generate_all_elements    → 元素图片（角色/道具/场景）
阶段2: generate_all_start_frames → 起始帧（每个镜头 1 张）
阶段3: generate_all_videos      → 视频片段
----------------------------------------------
（音频生成是独立接口，不在 pipeline 中）
```

**API 端点**:
- `/api/agent/projects/{id}/execute-pipeline` - 一键执行上述 3 阶段
- `/api/agent/projects/{id}/generate-audio` - 独立的音频生成（TTS）

### 1.2 核心矛盾

- **视频生成的时长粒度固定且短**（常见 6–8 秒）
- **实际旁白/对白为保证叙事完整往往更长且更细**（信息密度高、句子长、段落长）
- **音频是"事后补充"**，无法指导镜头切分
- 结果：后期出现大量 **音画无法同步**、需要 **强行拉伸/切碎/补镜头** 的救火工作

### 1.3 直接后果

- 剪辑成本上升（对齐+补镜头+重生成）
- 片段良品率下降（镜头无法承接文案）
- 生产节奏不稳定（返工随机且不可控）

---

## 2. 解决方案概览（音频先行）

### 2.1 目标流程（改造后）

```
文本脚本 → 音频（定节奏/定时长）→ 按音频切分镜头表 → 图片 → 视频 → 合成
    ↓              ↓                    ↓              ↓       ↓
creative_brief  audio_assets        segments/shots   frames  videos
```

### 2.2 方案核心思想（"主时钟切换"）

- 把"时间轴的决定权"交给音频：
  - 音频先定稿 = **镜头数量**、**每个镜头时长**、**转折点**都确定
  - 后期从"对齐救火"变成"按规格装配"

### 2.3 预期收益

- 音画同步难度显著降低（音轨锁死不动）
- 镜头拆分更细，失败可局部重做（返工颗粒度更小）
- 叙事节奏更自然（停顿/重音/转折点天然对应镜头变化）

---

## 3. 主项目代码结构参考

### 3.1 核心数据模型

**文件**: `backend/services/agent/models.py`

```python
class AgentProject:
    id: str                    # 项目 ID
    name: str                  # 项目名称
    creative_brief: Dict       # 创意简报（主题、风格、旁白音色等）
    elements: Dict[str, Dict]  # 元素库 {Element_ID: {name, type, description, image_url, voice_profile}}
    segments: List[Dict]       # 段落列表 [{id, name, shots: [...]}]
    audio_assets: List[Dict]   # 音频资产（当前仅存储，未指导切分）
    visual_assets: List[Dict]  # 视觉资产
    timeline: List[Dict]       # 时间轴（预留）
    audio_timeline: Dict       # 【新增】音频编排结果（约束视频生成）
```

### 3.2 新增数据模型：audio_timeline（约束结构）

**用途**: 音频编辑工作台确认后生成，作为约束传入 Agent Pipeline

```python
# 音频编排结果 → 作为约束传入 Agent
audio_timeline = {
    "version": "1.0",
    "confirmed": True,                    # 用户是否已确认
    "confirmed_at": "2024-01-15T10:30:00Z",
    "total_duration": 90.5,               # 总时长（秒）
    "master_audio_url": "...",            # 完整音频文件 URL
    "segments": [
        {
            "segment_id": "Seg_01",
            "segment_name": "开场",
            "shots": [
                {
                    "shot_id": "Shot_01",
                    "timecode_start": 0.0,      # 开始时间码
                    "timecode_end": 5.2,        # 结束时间码
                    "duration": 5.2,            # 时长（约束视频生成）
                    "narration": "第一句旁白...", # 旁白文本
                    "audio_clip_url": "...",    # 切片音频 URL（可选）
                    "suggested_type": "wide",   # 建议镜头类型
                    "suggested_description": "建立场景",
                    "user_notes": ""            # 用户备注
                }
            ]
        }
    ]
}
```

**约束作用**:
- `duration` → 约束 `generate_all_videos()` 中每个镜头的目标时长
- `timecode_start/end` → 用于后期合成对齐
- `narration` → 同步到 `shot.narration`，用于字幕生成

**Shot 结构**（`segments[].shots[]`）:
```python
{
    "id": "Shot_01",
    "name": "镜头1",
    "type": "standard",           # 镜头类型
    "description": "...",         # 镜头描述
    "prompt": "...",              # 起始帧提示词
    "video_prompt": "...",        # 视频提示词（可选覆盖）
    "narration": "...",           # 旁白文本
    "dialogue_script": "...",     # 对白脚本
    "duration": 5.0,              # 目标时长（秒）
    "start_image_url": None,      # 起始帧 URL
    "video_url": None,            # 视频 URL
    "voice_audio_url": None,      # 人声音频 URL
    "status": "pending"           # 状态
}
```

### 3.3 现有 API 端点

| 端点 | 功能 | 代码位置 |
|------|------|----------|
| `POST /api/agent/projects/{id}/generate-elements` | 生成元素图片 | main.py:2884 |
| `POST /api/agent/projects/{id}/generate-frames` | 生成起始帧 | main.py:3063 |
| `POST /api/agent/projects/{id}/generate-videos` | 生成视频 | main.py:3274 |
| `POST /api/agent/projects/{id}/generate-audio` | 生成音频（TTS） | main.py:3297 |
| `POST /api/agent/projects/{id}/execute-pipeline` | 一键执行（不含音频） | main.py:4185 |

### 3.4 新增 API 端点（待实现）

| 端点 | 功能 | 说明 |
|------|------|------|
| `POST /api/agent/projects/{id}/audio-segment` | 智能音频切分 | 根据文本+音频生成切分建议 |
| `POST /api/agent/projects/{id}/audio-timeline` | 保存音频编排结果 | 保存用户确认的 audio_timeline |
| `GET /api/agent/projects/{id}/audio-timeline` | 获取音频编排结果 | 获取已保存的 audio_timeline |
| `POST /api/agent/projects/{id}/execute-pipeline-v2` | 约束模式执行 | 在 audio_timeline 约束下执行原 Pipeline |

### 3.3 TTS 服务

**文件**: `backend/services/tts_service.py`

**支持的 Provider**:
- `volc_tts_v1_http` - 火山引擎 TTS
- `fish_tts` / `fish_tts_v1` - Fish Audio
- `aliyun_bailian_tts_v2` - 阿里云百炼 TTS
- `custom_*` - 自定义 OpenAI 兼容接口

**当前音频生成逻辑** (`main.py:3297-3900`):
1. 遍历所有 shots
2. 合并 `narration` + `dialogue_script` 为文本
3. 调用 TTS 生成音频
4. 存储到 `shot.voice_audio_url` 和 `project.audio_assets`

---

## 4. 改造方案详细规划

### Phase 1：新增"音频切分→镜头表"能力（优先级：高）

#### 4.1.1 新增 API：音频切分

**目标**: 根据音频时长和文本内容，自动生成镜头切分建议

**新增端点**: `POST /api/agent/projects/{id}/audio-segment`

**请求参数**:
```json
{
  "audio_url": "已上传的音频 URL（可选，用于提取时长）",
  "script_text": "旁白文本（必填）",
  "target_shot_duration": 5.0,   // 目标镜头时长
  "split_strategy": "auto"       // auto / sentence / timestamp
}
```

**返回结构**:
```json
{
  "segments": [
    {
      "segment_id": "Segment_01",
      "shots": [
        {
          "shot_id": "Shot_01",
          "timecode_start": 0.0,
          "timecode_end": 5.2,
          "narration": "第一句旁白...",
          "suggested_type": "wide",
          "suggested_description": "建立场景"
        }
      ]
    }
  ],
  "total_duration": 90.5,
  "shot_count": 18
}
```

**实现位置**: `backend/services/agent_service.py` 新增方法 `segment_by_audio()`

#### 4.1.2 切分逻辑

```python
async def segment_by_audio(
    self,
    project: AgentProject,
    script_text: str,
    audio_url: Optional[str] = None,
    target_duration: float = 5.0
) -> Dict:
    """
    切分策略：
    1. 按句号/自然停顿切分
    2. 按转折词（但是/于是/突然）切分
    3. 按目标时长估算（字数 / 语速）
    4. 合并过短段落，拆分过长段落
    """
```

**切分建议（时长区间）**:
- 信息密集段：3–6s/段
- 氛围铺垫段：5–9s/段
- 任何 >10s 的段落建议拆分

---

### Phase 2：调整 Pipeline 顺序（优先级：高）

#### 4.2.1 新的 execute_full_pipeline

**改造代码位置**: `backend/services/agent_service.py:3784`

**新流程**:
```python
async def execute_full_pipeline_v2(
    self,
    project: AgentProject,
    visual_style: str,
    resolution: str,
    audio_first: bool = True  # 新增参数
) -> Dict:
    """
    音频先行版本：

    阶段0: 生成音频（如果 shots 有 narration 且无 voice_audio_url）
    阶段1: 生成所有元素图片
    阶段2: 生成所有起始帧
    阶段3: 生成所有视频（时长参考音频）
    """

    if audio_first:
        # 阶段0: 生成音频
        print("[AgentExecutor] 阶段0: 生成音频")
        audio_result = await self.generate_all_audio(project)
        pipeline_result["stages"]["audio"] = audio_result

    # 阶段1-3: 原有逻辑
    ...
```

#### 4.2.2 新增 API 端点

**新增端点**: `POST /api/agent/projects/{id}/execute-pipeline-v2`

**请求参数**:
```json
{
  "visualStyle": "吉卜力动画风格",
  "resolution": "720p",
  "audioFirst": true,
  "ttsProvider": "volc_tts_v1_http"
}
```

---

### Phase 3：视频时长自适应（优先级：中）

#### 4.3.1 问题

当前视频生成固定时长（6s），无法匹配音频段落时长。

#### 4.3.2 解决方案

**修改位置**: `backend/services/agent_service.py:3314` (`generate_all_videos`)

```python
# 从 shot 获取目标时长
target_duration = shot.get("duration", 6.0)

# 如果 shot 有音频，使用音频时长
if shot.get("voice_audio_url"):
    audio_duration = await self._get_audio_duration(shot["voice_audio_url"])
    if audio_duration:
        target_duration = audio_duration

# 传递给视频生成服务
result = await video_service.generate_video(
    image_url=shot["start_image_url"],
    prompt=video_prompt,
    duration=target_duration,  # 使用自适应时长
    ...
)
```

---

### Phase 4：前端适配 - 音频编辑工作台（优先级：高）

#### 4.4.1 设计原则

- **独立模块**：编辑工作台作为 AgentPage 的前置步骤，不嵌入 Agent 对话流程
- **用户确认制**：必须用户点击"确认"后才能进入原有 Pipeline
- **可视化优先**：波形、时间轴、切分点都要可视化操作

#### 4.4.2 组件架构

```
src/
├── pages/
│   └── AgentPage.tsx                    # 主页面（增加工作台入口）
├── components/
│   └── audio-workbench/                 # 【新增】音频编辑工作台目录
│       ├── AudioWorkbench.tsx           # 主容器组件
│       ├── WaveformDisplay.tsx          # 音频波形显示
│       ├── SegmentTimeline.tsx          # 切分时间轴
│       ├── ShotListEditor.tsx           # 镜头列表编辑
│       ├── PlaybackControls.tsx         # 播放控制
│       └── hooks/
│           ├── useAudioAnalysis.ts      # 音频分析 hook
│           └── useSegmentEditor.ts      # 切分编辑 hook
```

#### 4.4.3 AudioWorkbench 主组件设计

**文件**: `src/components/audio-workbench/AudioWorkbench.tsx`

```typescript
interface AudioWorkbenchProps {
  projectId: string;
  scriptText: string;              // 旁白脚本
  onConfirm: (timeline: AudioTimeline) => void;  // 确认回调
  onCancel: () => void;
}

interface AudioTimeline {
  version: string;
  confirmed: boolean;
  totalDuration: number;
  masterAudioUrl: string;
  segments: Segment[];
}

interface Segment {
  segmentId: string;
  segmentName: string;
  shots: Shot[];
}

interface Shot {
  shotId: string;
  timecodeStart: number;
  timecodeEnd: number;
  duration: number;
  narration: string;
  audioClipUrl?: string;
  suggestedType: 'wide' | 'standard' | 'closeup' | 'quick' | 'montage';
  suggestedDescription: string;
  userNotes: string;
}
```

#### 4.4.4 编辑工作台核心功能

| 功能 | 组件 | 说明 |
|------|------|------|
| 音频波形显示 | `WaveformDisplay` | 使用 wavesurfer.js 可视化整段音频 |
| 切分点拖拽 | `SegmentTimeline` | 可视化切分点，支持拖拽调整 |
| 文本对照 | `ShotListEditor` | 显示每段对应的旁白文本 |
| 智能切分建议 | API 调用 | 调用后端 `/audio-segment` 获取建议 |
| 镜头类型标注 | `ShotListEditor` | 为每段标记 wide/closeup/standard |
| 预览/试听 | `PlaybackControls` | 播放选中片段或全部 |
| 确认/取消 | `AudioWorkbench` | 确认后保存 audio_timeline 到项目 |

#### 4.4.5 用户操作流程（UI 层面）

```
┌─────────────────────────────────────────────────────────────┐
│  AgentPage                                                  │
│  ┌───────────────────────────────────────────────────────┐ │
│  │  步骤指示器: [脚本] → [音频编排] → [视频生成]           │ │
│  └───────────────────────────────────────────────────────┘ │
│                                                             │
│  当前步骤：音频编排                                          │
│  ┌───────────────────────────────────────────────────────┐ │
│  │  ┌─────────────────────────────────────────────────┐  │ │
│  │  │  [波形显示区域]                                  │  │ │
│  │  │  ═══════●════════●═══════●════════●══════════   │  │ │
│  │  │        0:05      0:12    0:18     0:25          │  │ │
│  │  └─────────────────────────────────────────────────┘  │ │
│  │                                                        │ │
│  │  ┌─────────────────────────────────────────────────┐  │ │
│  │  │  镜头列表                                        │  │ │
│  │  │  ┌───┬────────┬──────────────┬────────┬──────┐  │  │ │
│  │  │  │ # │ 时间码  │ 旁白文本     │ 类型   │ 操作 │  │  │ │
│  │  │  ├───┼────────┼──────────────┼────────┼──────┤  │  │ │
│  │  │  │ 1 │ 0:00-5s│ 第一句...    │ wide ▼ │ ▶ ✏ │  │  │ │
│  │  │  │ 2 │ 5s-12s │ 第二句...    │standard│ ▶ ✏ │  │  │ │
│  │  │  │ 3 │ 12s-18s│ 第三句...    │closeup │ ▶ ✏ │  │  │ │
│  │  │  └───┴────────┴──────────────┴────────┴──────┘  │  │ │
│  │  └─────────────────────────────────────────────────┘  │ │
│  │                                                        │ │
│  │  [智能切分] [添加切点] [合并相邻]    [取消] [确认编排]  │ │
│  └───────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

#### 4.4.6 AgentPage 集成方式

**修改文件**: `src/pages/AgentPage.tsx`

```typescript
// 新增状态
const [workflowStep, setWorkflowStep] = useState<'script' | 'audio' | 'pipeline'>('script');
const [audioTimeline, setAudioTimeline] = useState<AudioTimeline | null>(null);

// 新增入口按钮（在脚本确定后显示）
{workflowStep === 'script' && hasScript && (
  <Button onClick={() => setWorkflowStep('audio')}>
    进入音频编排
  </Button>
)}

// 显示编辑工作台
{workflowStep === 'audio' && (
  <AudioWorkbench
    projectId={project.id}
    scriptText={project.creative_brief.script}
    onConfirm={(timeline) => {
      setAudioTimeline(timeline);
      setWorkflowStep('pipeline');
      // 保存到后端
      saveAudioTimeline(project.id, timeline);
    }}
    onCancel={() => setWorkflowStep('script')}
  />
)}

// 原有 Pipeline 执行（在音频编排确认后）
{workflowStep === 'pipeline' && audioTimeline?.confirmed && (
  <PipelineExecutor
    projectId={project.id}
    audioTimeline={audioTimeline}  // 传入约束
  />
)}
```

---

## 5. 可执行生产流程（SOP）

### 流程总览

```
Step 0: 脚本准备
    ↓
Step 1: 生成音频（TTS）
    ↓
Step 2: 【新增】音频编辑工作台
    ├── 2.1 智能切分建议
    ├── 2.2 手动调整切点
    ├── 2.3 标注镜头类型
    └── 2.4 确认编排结果 → 生成 audio_timeline
    ↓
Step 3: 生成元素图片（受 audio_timeline 约束）
    ↓
Step 4: 生成起始帧（受 audio_timeline 约束）
    ↓
Step 5: 生成视频（时长受 audio_timeline.duration 约束）
    ↓
Step 6: 导出/合成
```

---

### Step 0：脚本准备

**用户操作**:
1. 在 AgentPage 中输入/粘贴旁白脚本
2. 或通过对话让 AI 生成脚本

**代码路径**: `AgentService.chat()` → `creative_brief.script`

**验收标准**:
- 单句尽量"单信息点"
- 每个句末/段末留出可停顿点
- 关键名词/场景词尽量提前出现

---

### Step 1：生成音频（主时钟）

**用户操作**:
1. 点击"生成音频"按钮
2. 或在 Pipeline 中启用"音频先行"模式

**API**: `POST /api/agent/projects/{id}/generate-audio`

**代码路径**: `main.py:3297` → TTS 服务

**验收标准**:
- 语速稳定、停顿合理、情绪符合剧情
- 生成后自动填充 `shot.voice_audio_url`

---

### Step 2：音频编辑工作台（用户确认）

**用户操作**:
1. 点击"进入音频编排"进入编辑工作台
2. 点击"智能切分"获取 AI 建议的切分点
3. 在波形图上拖拽调整切分点位置
4. 为每个镜头选择类型（wide/standard/closeup）
5. 预览/试听各片段
6. 点击"确认编排"保存结果

**前端组件**: `AudioWorkbench.tsx`

**API 调用**:
- `POST /api/agent/projects/{id}/audio-segment` - 获取智能切分建议
- `POST /api/agent/projects/{id}/audio-timeline` - 保存确认结果

**输出**:
- 生成 `audio_timeline` 对象
- 自动更新 `project.segments` 和 `project.shots`
- 每个 shot 带 `timecode_start`、`timecode_end`、`duration`、`narration`

**验收标准**:
- [ ] 切分点与语句停顿对齐
- [ ] 无过短片段（<2s）或过长片段（>10s）
- [ ] 镜头类型标注合理（信息段用 standard，氛围段用 wide）

---

### Step 3：生成元素图片（约束模式）

**前置条件**: `audio_timeline.confirmed === true`

**用户操作**: 自动或点击"生成元素"

**API**: `POST /api/agent/projects/{id}/generate-elements`

**代码路径**: `AgentService.generate_all_elements()` (line 2808)

**约束影响**:
- 镜头数量已由 audio_timeline 确定
- 根据 narration 中提及的角色/道具自动识别需要生成的元素

---

### Step 4：生成起始帧（约束模式）

**前置条件**: `audio_timeline.confirmed === true`

**用户操作**: 自动或点击"生成起始帧"

**API**: `POST /api/agent/projects/{id}/generate-frames`

**代码路径**: `AgentService.generate_all_start_frames()` (line 2970)

**关键逻辑**:
- 自动收集元素参考图（角色一致性）
- 上一镜头起始帧作为参考（场景一致性）

**约束影响**:
- 镜头数量 = `audio_timeline.segments[].shots.length` 总和
- 每个 shot 的 `suggested_type` 影响 prompt 构建

---

### Step 5：生成视频（约束模式）

**前置条件**: `audio_timeline.confirmed === true`

**用户操作**: 自动或点击"生成视频"

**API**: `POST /api/agent/projects/{id}/generate-videos`

**代码路径**: `AgentService.generate_all_videos()` (line 3314)

**关键约束**:
```python
# 从 audio_timeline 获取目标时长
target_duration = audio_timeline_shot.get("duration", 6.0)

# 传递给视频生成服务
result = await video_service.generate_video(
    image_url=shot["start_image_url"],
    prompt=video_prompt,
    duration=target_duration,  # 使用约束时长
    ...
)
```

**约束影响**:
- 每个视频时长 = 对应 audio_timeline.shot.duration
- 若工具固定 6s，生成后剪辑到目标时长

---

### Step 6：导出/合成

**用户操作**: 点击"导出资产"或"导出视频"

**API**:
- `POST /api/agent/projects/{id}/export/assets` - 导出所有素材
- `POST /api/agent/projects/{id}/export/video` - 拼接视频

**代码路径**: `main.py:2611`, `main.py:2648`

---

## 6. 质量控制与验收标准（Checklist）

### 6.1 音画同步

- [ ] 口播关键名词出现时画面有承接（人物/道具/场景/字幕）
- [ ] 段落转折点有镜头变化或画面节奏变化
- [ ] 没有明显"嘴在说但画面无关"的长时间段（>3s）

### 6.2 节奏与可看性

- [ ] 镜头切换不过碎（避免每 2s 一切）
- [ ] 信息密集段采用稳定构图，减少漂移
- [ ] 氛围段允许更自由的运动与抽象表达

### 6.3 一致性

- [ ] 同一角色外观稳定（发型/服饰/特征）
- [ ] 同一场景色调/光线一致
- [ ] 关键道具在多镜头中不突变

---

## 7. 逻辑上要注意的坑（以及对策）

### 坑 1：人物对话/口型同步仍然难

**风险**: 解决的是"时长对齐"，但角色开口说话会暴露口型问题。

**对策**:
- 把"开口说话"交给专门口型模块（独立环节）
- 或采用规避镜头语言：背影/侧脸/远景/手部特写
- 叙事上用"旁白讲述 + 角色不正面说话"更稳

**代码参考**: `_build_video_prompt_for_shot()` 中的 `audio_rules`:
```python
audio_rules = (
    "音频规则：只保留自然环境音/音效，禁止任何旁白/对白/人声。"
)
```

---

### 坑 2：切分过碎导致剪辑焦虑

**对策**:
- 同一镜头覆盖两句旁白（不必每句都切）
- 用"镜头内部运动"替代硬切
- 节奏点切，非句子切

---

### 坑 3：生成视频运动不可控

**对策**:
- 信息/解释镜头：固定镜头 + 清晰构图（`type: "standard"`）
- 运动镜头：放到氛围段（`type: "wide"` 或 `type: "montage"`）

**代码参考**: `SHOT_TYPES` 映射 (`agent/constants.py`):
```python
SHOT_TYPES = {
    "standard": "自然流畅的角色动作与轻微镜头运动",
    "quick": "节奏更快的动作与镜头移动",
    "closeup": "以角色表情与细节为主",
    "wide": "展示环境与空间关系，缓慢平移",
    "montage": "更强的节奏感与剪辑感"
}
```

---

### 坑 4：角色一致性漂移

**对策**:
1. 固定"角色卡描述"（`elements[].description`）
2. 使用参考图（`_collect_element_reference_images()`）
3. 同场景多镜头从同一关键帧衍生

**代码参考**: `generate_all_start_frames()` (line 3039-3072):
```python
# 收集角色参考图
reference_images = self._collect_element_reference_images(prompt, project.elements)

# 添加上一镜头起始帧
if prev_shot:
    reference_images.append(prev_shot.get("start_image_url"))
```

---

### 坑 5：旁白太长 → 镜头数量爆炸

**对策**:
- 先按 `总时长 / 5s` 粗估镜头数
  - 90s 旁白 ≈ 18 镜头
  - 若估算 35+ 镜头：考虑压缩文案

---

### 坑 6：某些段落画面不够用

**对策**: 建立补镜头库
- 环境空镜：天空、街景、室内细节
- 道具特写：书、手机、票据
- 情绪过渡：光斑、虚焦、慢推拉

---

## 8. 实施路线

### Phase A：后端 API 实现（优先级：高）

**目标**: 实现音频切分和 timeline 存储的后端能力

**任务**:
1. 新增 `segment_by_audio()` 方法 - 智能切分算法
2. 新增 `/api/agent/projects/{id}/audio-segment` 端点
3. 新增 `/api/agent/projects/{id}/audio-timeline` 端点（GET/POST）
4. 扩展 AgentProject 模型，添加 `audio_timeline` 字段

**涉及文件**:
- `backend/services/agent_service.py`
- `backend/services/agent/models.py`
- `backend/main.py`

**验收标准**:
- [ ] 30-60 秒旁白可正确切分
- [ ] audio_timeline 可保存/读取
- [ ] 切分结果与音频时长一致

---

### Phase B：前端编辑工作台（优先级：高）

**目标**: 实现可视化音频编排界面

**任务**:
1. 创建 `src/components/audio-workbench/` 目录结构
2. 实现 `AudioWorkbench.tsx` 主容器
3. 实现 `WaveformDisplay.tsx` 音频波形（wavesurfer.js）
4. 实现 `SegmentTimeline.tsx` 切分点编辑
5. 实现 `ShotListEditor.tsx` 镜头列表
6. 实现 `PlaybackControls.tsx` 播放控制
7. 集成到 `AgentPage.tsx`

**涉及文件**:
- `src/components/audio-workbench/*.tsx`（新增）
- `src/pages/AgentPage.tsx`（修改）

**依赖库**:
- `wavesurfer.js` - 音频波形可视化
- 或使用现有的 audio 元素 + canvas 自绘

**验收标准**:
- [ ] 波形正确显示
- [ ] 切分点可拖拽
- [ ] 镜头列表与波形联动
- [ ] 确认后正确调用后端 API

---

### Phase C：Pipeline 约束集成（优先级：中）

**目标**: 原有 Pipeline 在 audio_timeline 约束下执行

**任务**:
1. 新增 `execute_full_pipeline_v2()` 方法
2. 新增 `/api/agent/projects/{id}/execute-pipeline-v2` 端点
3. 修改 `generate_all_videos()` 读取 audio_timeline.duration
4. 前端 Pipeline 执行时传入 audioTimeline 参数

**涉及文件**:
- `backend/services/agent_service.py`
- `backend/main.py`
- `src/pages/AgentPage.tsx`

**关键逻辑**:
```python
async def execute_full_pipeline_v2(
    self,
    project: AgentProject,
    visual_style: str,
    resolution: str,
    audio_timeline: Optional[Dict] = None  # 约束参数
) -> Dict:
    """
    在 audio_timeline 约束下执行 Pipeline：

    1. 如果 audio_timeline 存在且 confirmed=True：
       - 从 audio_timeline 同步 segments/shots
       - 视频生成时使用 audio_timeline.shot.duration
    2. 否则使用原有逻辑
    """
```

**验收标准**:
- [ ] 有 audio_timeline 时视频时长正确
- [ ] 无 audio_timeline 时退化为原有行为
- [ ] 生成的视频与音频时长匹配

---

### Phase D：合成与导出优化（优先级：低）

**目标**: 利用 timecode 实现精确合成

**任务**:
1. 导出时按 timecode 对齐音画
2. 支持导出带字幕的视频
3. 支持导出剪映/Premiere 工程文件

**涉及文件**:
- `backend/services/export_service.py`
- `backend/main.py`

---

## 9. 镜头表模板（直接可用）

| # | Timecode | 音频文本（字幕源） | 画面意图 | 镜头类型 | 视觉关键词 | shot.type |
|---|----------|--------------------|----------|----------|------------|-----------|
| 01 | 00:00.0–00:05.2 | …… | 建立场景 | 远景/固定 | 城市夜景、雨 | wide |
| 02 | 00:05.2–00:10.0 | …… | 引出主角 | 中景/轻推 | 主角背影 | standard |
| 03 | 00:10.0–00:14.6 | …… | 信息点1 | 近景/固定 | 手机屏幕 | closeup |

---

## 10. 相关代码索引

### 现有代码

| 功能 | 文件 | 行号 | 说明 |
|------|------|------|------|
| Pipeline 入口 | `agent_service.py` | 3784 | `execute_full_pipeline()` |
| 元素生成 | `agent_service.py` | 2808 | `generate_all_elements()` |
| 起始帧生成 | `agent_service.py` | 2970 | `generate_all_start_frames()` |
| 视频生成 | `agent_service.py` | 3314 | `generate_all_videos()` |
| 视频 Prompt 构建 | `agent_service.py` | 2712 | `_build_video_prompt_for_shot()` |
| 角色一致性提示 | `agent_service.py` | 3670 | `_build_character_consistency_prompt()` |
| 参考图收集 | `agent_service.py` | 3738 | `_collect_element_reference_images()` |
| 音频生成 | `main.py` | 3297 | `generate_project_audio()` |
| TTS 服务 | `tts_service.py` | - | 多 Provider 支持 |
| 项目模型 | `agent/models.py` | 1 | `AgentProject` |
| 镜头类型 | `agent/constants.py` | 1 | `SHOT_TYPES` |

### 新增代码（待实现）

| 功能 | 文件 | 说明 |
|------|------|------|
| 音频切分 | `agent_service.py` | `segment_by_audio()` 方法 |
| 约束 Pipeline | `agent_service.py` | `execute_full_pipeline_v2()` 方法 |
| 切分端点 | `main.py` | `POST /audio-segment` |
| Timeline 端点 | `main.py` | `GET/POST /audio-timeline` |
| 约束 Pipeline 端点 | `main.py` | `POST /execute-pipeline-v2` |
| 编辑工作台主组件 | `audio-workbench/AudioWorkbench.tsx` | 前端主容器 |
| 波形显示 | `audio-workbench/WaveformDisplay.tsx` | wavesurfer.js 封装 |
| 时间轴编辑 | `audio-workbench/SegmentTimeline.tsx` | 切分点拖拽 |
| 镜头列表 | `audio-workbench/ShotListEditor.tsx` | 镜头编辑表格 |
| 播放控制 | `audio-workbench/PlaybackControls.tsx` | 播放/暂停/跳转 |

---

## 11. 结论（执行要点）

### 架构设计要点

1. **编辑工作台是外部独立模块** - 不侵入 Agent 内部逻辑
2. **用户确认制** - audio_timeline 必须用户确认后才生效
3. **约束传递** - Pipeline 执行时读取 audio_timeline 作为约束
4. **向后兼容** - 无 audio_timeline 时退化为原有行为

### 核心改造清单

| 优先级 | 任务 | 涉及文件 |
|--------|------|----------|
| 高 | 后端: `segment_by_audio()` | `agent_service.py` |
| 高 | 后端: audio-timeline API | `main.py` |
| 高 | 前端: AudioWorkbench 组件 | `src/components/audio-workbench/` |
| 中 | 后端: `execute_full_pipeline_v2()` | `agent_service.py` |
| 中 | 前端: AgentPage 集成 | `AgentPage.tsx` |
| 低 | 导出: timecode 对齐 | `export_service.py` |

### 关键约束关系

```
audio_timeline.confirmed = true
    ↓
audio_timeline.shots[].duration → generate_all_videos() 时长约束
audio_timeline.shots[].narration → shot.narration 同步
audio_timeline.shots[].suggested_type → 镜头 prompt 构建参考
```

### 不要做的事

- ❌ 不要改动 `execute_full_pipeline()` 原有逻辑
- ❌ 不要在 Agent 对话流程中嵌入编辑工作台
- ❌ 不要自动确认 audio_timeline（必须用户手动确认）

### 最终效果

音轨锁定后，后期的主要工作将从 **"音画对齐救火"** 转为 **"按 timecode 装配与局部优化"**。

用户在编辑工作台中确认切分后，整个视频生产流程将在**确定性约束**下执行，大幅降低返工概率。
