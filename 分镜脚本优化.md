# AI Storyboarder 分镜脚本开发指南

本文档面向开发者，涵盖：项目架构、分镜生成流程、提示词构建逻辑、质量优化策略，以及未来音频先行的流程改造方向。

更新时间：2026-02-03

---

## 目录

1. [项目架构概览](#1-项目架构概览)
2. [快速启动](#2-快速启动)
3. [分镜生成核心流程](#3-分镜生成核心流程)
4. [Agent 模式深度解析](#4-agent-模式深度解析)
5. [提示词构建逻辑](#5-提示词构建逻辑)
6. [分镜质量优化策略](#6-分镜质量优化策略)
7. [音频先行流程改造（规划中）](#7-音频先行流程改造规划中)
8. [配置与扩展](#8-配置与扩展)
9. [数据落盘与目录说明](#9-数据落盘与目录说明)
10. [常见问题](#10-常见问题)

---

## 1. 项目架构概览

### 1.1 项目形态

- **桌面端**：Electron 启动前端 UI，并在本地启动 Python(FastAPI) 后端（`electron/main.js`）
- **开发模式**：Vite 开发服务器（`http://localhost:5174`）+ FastAPI（`http://localhost:8001`）
- **打包**：Electron Builder；后端可用 PyInstaller 打成 `backend-server.exe`（见 `BUILD.md`）

### 1.2 技术栈

| 层级 | 技术 | 说明 |
|------|------|------|
| 前端 | React + TypeScript + Vite | TailwindCSS + Zustand（HashRouter） |
| 后端 | Python + FastAPI + Uvicorn | httpx/aiohttp 对接 LLM/图像/视频/TTS |
| 存储 | 本地 YAML 文件 | `backend/services/storage_service.py` |
| 静态资源 | `/api/uploads/...` | 图片/音频/视频文件挂载 |

### 1.3 核心服务拆分

```
backend/services/
├── llm_service.py          # LLM 调用（脚本拆解、对话）
├── image_service.py        # 图像生成（多 provider）
├── video_service.py        # 视频生成（多 provider + 任务轮询）
├── tts_service.py          # TTS 语音合成
├── agent_service.py        # Agent 项目与流水线执行 ★
├── storage_service.py      # 统一落盘与配置读取
└── agent/
    ├── models.py           # AgentProject 数据模型
    └── constants.py        # 镜头类型、风格常量
```

---

## 2. 快速启动

### 2.1 前置要求

- Node.js 18+
- Python 3.9+（建议 3.10+）

### 2.2 一键启动（Windows）

```bash
npm install
npm run start
```

`start.ps1` 会自动检查依赖并分别启动前端与后端。

### 2.3 手动启动（适合调试）

```bash
# 终端 1：后端
npm run python:dev

# 终端 2：前端
npm run dev
```

可访问：
- 前端：`http://localhost:5174`
- 后端：`http://localhost:8001`
- OpenAPI 文档：`http://localhost:8001/docs`

### 2.4 Electron 开发模式

```bash
npm run electron:dev
```

---

## 3. 分镜生成核心流程

### 3.1 两种模式对比

| 特性 | 普通模式（/home） | Agent 模式（/agent） |
|------|------------------|---------------------|
| 入口 | `/api/parse-story` | `/api/agent/projects/{id}/chat` |
| 分镜结构 | 扁平镜头列表 | 结构化 segments → shots |
| 元素管理 | 无 | 角色/场景/道具分类管理 |
| 一致性 | 靠提示词 | 参考图 + 元素库 |
| 适用场景 | 快速原型 | 完整项目制作 |

### 3.2 普通模式流程

```
用户输入剧本
    ↓
/api/parse-story（LLM 拆解）
    ↓
生成镜头列表 [{prompt, description, ...}]
    ↓
/api/generate-image（逐镜头生成）
    ↓
/api/generate-video（图生视频）
```

**代码入口**: `backend/main.py` → `parse_story()`

### 3.3 Agent 模式流程（推荐）

```
用户输入创意简报（creative_brief）
    ↓
AI 对话生成结构化脚本
    ↓
自动提取 elements（角色/场景/道具）
    ↓
生成 segments 和 shots（分镜表）
    ↓
execute_full_pipeline()
    ├── 阶段1: generate_all_elements()    → 元素图片
    ├── 阶段2: generate_all_start_frames() → 起始帧
    └── 阶段3: generate_all_videos()       → 视频片段
    ↓
导出/合成
```

**代码入口**: `backend/services/agent_service.py`

---

## 4. Agent 模式深度解析

### 4.1 核心数据模型

**文件**: `backend/services/agent/models.py`

```python
class AgentProject:
    id: str                    # 项目 ID
    name: str                  # 项目名称
    creative_brief: Dict       # 创意简报
    elements: Dict[str, Dict]  # 元素库 {Element_ID: {...}}
    segments: List[Dict]       # 段落列表 [{id, name, shots: [...]}]
    audio_assets: List[Dict]   # 音频资产
    visual_assets: List[Dict]  # 视觉资产
    timeline: List[Dict]       # 时间轴
    agent_memory: Dict         # AI 记忆（上下文）
```

### 4.2 Shot 结构

```python
{
    "id": "Shot_01",
    "name": "镜头1",
    "type": "standard",           # 镜头类型（见 4.3）
    "description": "...",         # 镜头描述
    "prompt": "...",              # 起始帧提示词
    "video_prompt": "...",        # 视频提示词（可选覆盖）
    "narration": "...",           # 旁白文本
    "dialogue_script": "...",     # 对白脚本
    "duration": 5.0,              # 目标时长（秒）
    "start_image_url": None,      # 起始帧 URL
    "video_url": None,            # 视频 URL
    "voice_audio_url": None,      # 人声音频 URL
    "status": "pending"           # 状态
}
```

### 4.3 镜头类型（SHOT_TYPES）

**文件**: `backend/services/agent/constants.py`

| type | 含义 | 适用场景 |
|------|------|----------|
| `standard` | 自然流畅的角色动作与轻微镜头运动 | 对话、叙事 |
| `quick` | 节奏更快的动作与镜头移动 | 动作、紧张 |
| `closeup` | 角色表情与细节为主 | 情绪特写 |
| `wide` | 展示环境与空间关系，缓慢平移 | 建立镜头 |
| `montage` | 更强的节奏感与剪辑感 | 蒙太奇 |

### 4.4 Pipeline API 端点

| 端点 | 功能 | 代码位置 |
|------|------|----------|
| `POST .../generate-elements` | 生成元素图片 | main.py:2884 |
| `POST .../generate-frames` | 生成起始帧 | main.py:3063 |
| `POST .../generate-videos` | 生成视频 | main.py:3274 |
| `POST .../generate-audio` | 生成音频（TTS） | main.py:3297 |
| `POST .../execute-pipeline` | 一键执行（不含音频） | main.py:4185 |

---

## 5. 提示词构建逻辑

### 5.1 起始帧提示词构建

**代码位置**: `agent_service.py` → `generate_all_start_frames()` (line 2970)

```python
# 提示词组成
final_prompt = f"""
{visual_style}           # 视觉风格（如"吉卜力动画风格"）
{shot.prompt}            # 镜头描述
{character_prompt}       # 角色一致性提示
"""

# 参考图收集
reference_images = [
    元素参考图,           # _collect_element_reference_images()
    上一镜头起始帧        # 场景一致性
]
```

### 5.2 视频提示词构建（7 层结构）

**代码位置**: `agent_service.py:2712` → `_build_video_prompt_for_shot()`

```python
video_prompt = f"""
{style_prefix}           # 1. 风格前缀
{shot_type_motion}       # 2. 镜头类型对应的运动描述
{base_description}       # 3. 基础镜头描述
{character_actions}      # 4. 角色动作
{camera_movement}        # 5. 镜头运动
{atmosphere}             # 6. 氛围/情绪
{audio_rules}            # 7. 音频规则（禁止人声）
"""
```

**音频规则示例**:
```python
audio_rules = "音频规则：只保留自然环境音/音效，禁止任何旁白/对白/人声。"
```

### 5.3 角色一致性提示

**代码位置**: `agent_service.py:3670` → `_build_character_consistency_prompt()`

```python
# 从 elements 中提取角色描述
character_prompt = """
角色一致性要求：
- 主角：黑色短发，穿白色衬衫，棕色眼睛
- 配角：金色长发，蓝色连衣裙
确保角色外观在所有镜头中保持一致。
"""
```

### 5.4 参考图收集

**代码位置**: `agent_service.py:3738` → `_collect_element_reference_images()`

```python
def _collect_element_reference_images(self, prompt: str, elements: Dict) -> List[str]:
    """
    从提示词中提取提及的元素名称，
    收集对应的元素图片作为参考图
    """
    reference_images = []
    for element_id, element in elements.items():
        if element["name"] in prompt:
            if element.get("image_url"):
                reference_images.append(element["image_url"])
    return reference_images
```

---

## 6. 分镜质量优化策略

### 6.1 常见问题与对策

| 问题 | 原因 | 对策 |
|------|------|------|
| 角色外观漂移 | 无参考图/描述不一致 | 固定元素库描述 + 使用参考图 |
| 场景不连贯 | 镜头间无关联 | 上一帧作为参考图 |
| 视频时长不可控 | 工具固定 6s | 后期剪辑 / 音频先行约束 |
| 口型不同步 | AI 视频限制 | 规避正脸说话镜头 |
| 运动过于剧烈 | 提示词不当 | 使用 `standard` 类型 |

### 6.2 提示词优化建议

**DO**:
- 使用具体的视觉描述（颜色、材质、光线）
- 明确角色动作（"缓慢转头"而非"转头"）
- 指定镜头运动（"镜头缓慢推进"）
- 保持风格一致性（每个提示词都加风格前缀）

**DON'T**:
- 避免抽象描述（"美丽的"、"令人惊叹的"）
- 避免过多角色同时出现
- 避免复杂的连续动作
- 避免正面说话的镜头（口型问题）

### 6.3 镜头切分原则

| 场景类型 | 建议时长 | 镜头类型 |
|----------|----------|----------|
| 信息密集段 | 3-6s | `standard` / `closeup` |
| 氛围铺垫段 | 5-9s | `wide` |
| 动作场景 | 4-6s | `quick` |
| 转场/过渡 | 2-4s | `montage` |

**原则**:
- 单镜头不超过 10s（AI 视频质量下降）
- 单镜头不少于 2s（太碎影响观感）
- 转折点应有镜头变化

### 6.4 一致性检查清单

- [ ] 同一角色外观稳定（发型/服饰/特征）
- [ ] 同一场景色调/光线一致
- [ ] 关键道具在多镜头中不突变
- [ ] 镜头切换节奏合理（不过碎）
- [ ] 信息密集段采用稳定构图

---

## 7. 音频先行流程改造（规划中）

> 详细规划见：`视频制作流程优化.md`

### 7.1 问题背景

当前流程：**视频先行 → 音频事后补充**

结果：
- 视频时长固定（6-8s），旁白往往更长
- 后期需要大量"音画对齐救火"
- 返工随机且不可控

### 7.2 改造目标

新流程：**音频先行 → 约束视频生成**

```
┌─────────────────────────────────────────────────────────────────┐
│                   音频编辑工作台（新增独立模块）                    │
├─────────────────────────────────────────────────────────────────┤
│  脚本文本 → TTS生成 → 音频波形 → 切分编辑 → 确认                  │
│                          ↓                                      │
│              生成 audio_timeline（带 timecode 的镜头表）          │
└─────────────────────────────────────────────────────────────────┘
                           ↓ 用户确认
┌─────────────────────────────────────────────────────────────────┐
│                    Agent Pipeline（原有，不变）                   │
├─────────────────────────────────────────────────────────────────┤
│  元素生成 → 起始帧生成 → 视频生成                                 │
│           受 audio_timeline 约束（镜头数、时长、切点）             │
└─────────────────────────────────────────────────────────────────┘
```

### 7.3 核心改造点

| 优先级 | 任务 | 涉及文件 |
|--------|------|----------|
| 高 | 新增 `segment_by_audio()` | `agent_service.py` |
| 高 | 新增 `/audio-segment` API | `main.py` |
| 高 | 新增 AudioWorkbench 组件 | `src/components/audio-workbench/` |
| 中 | 新增 `execute_full_pipeline_v2()` | `agent_service.py` |
| 低 | 导出时 timecode 对齐 | `export_service.py` |

### 7.4 audio_timeline 数据结构

```python
audio_timeline = {
    "version": "1.0",
    "confirmed": True,                    # 用户是否已确认
    "total_duration": 90.5,               # 总时长（秒）
    "master_audio_url": "...",            # 完整音频文件 URL
    "segments": [
        {
            "segment_id": "Seg_01",
            "shots": [
                {
                    "shot_id": "Shot_01",
                    "timecode_start": 0.0,
                    "timecode_end": 5.2,
                    "duration": 5.2,            # 约束视频生成时长
                    "narration": "第一句旁白...",
                    "suggested_type": "wide"
                }
            ]
        }
    ]
}
```

### 7.5 设计原则

1. **最小侵入性** - Agent 内部逻辑不动，只在外层添加约束
2. **用户可控** - 必须用户手动确认后才生效
3. **向后兼容** - 无 audio_timeline 时退化为原有行为

---

## 8. 配置与扩展

### 8.1 配置文件

后端配置文件位于 `backend/data/`，优先级（高 → 低）：

1. `settings.local.yaml`（本机私有，已被 `.gitignore` 忽略）
2. `settings.yaml`（仓库默认模板）

自定义 Provider：

1. `custom_providers.local.yaml`
2. `custom_providers.yaml`

模板文件：
- `backend/data/settings.yaml.example`
- `backend/data/custom_providers.yaml.example`

### 8.2 配置字段

```yaml
llm:
  provider: "openai"
  apiKey: "sk-..."
  baseUrl: "https://api.openai.com/v1"
  model: "gpt-4o"

image:
  provider: "silicon"
  apiKey: "..."
  model: "flux-1.1-pro"

video:
  provider: "minimax"
  apiKey: "..."

tts:
  provider: "volc"
  appId: "..."
  accessToken: "..."
```

### 8.3 TTS Provider

| Provider | 说明 |
|----------|------|
| `volc_tts_v1_http` | 火山引擎 TTS |
| `fish_tts` / `fish_tts_v1` | Fish Audio |
| `aliyun_bailian_tts_v2` | 阿里云百炼 TTS |
| `custom_*` | 自定义 OpenAI 兼容接口 |

测试接口：`/api/tts/test`

### 8.4 新增 Provider 步骤

1. 前端设置页新增 provider 选项（或写入 `custom_providers*.yaml`）
2. 后端在对应 service 中实现调用分支
3. 用 `/api/test-connection` 与 `/api/tts/test` 验证

---

## 9. 数据落盘与目录说明

### 9.1 数据目录

```
backend/data/
├── projects/           # 普通项目（脚本拆解/分镜生成）
├── agent_projects/     # Agent 模式项目 ★
├── scripts/            # 脚本数据
├── images/             # 图片历史与索引
├── videos/             # 视频历史与索引
├── chat/               # 聊天与会话记录
├── exports/            # 导出任务产物
├── settings.yaml       # 配置文件
└── custom_providers.yaml
```

### 9.2 媒体文件

```
backend/
├── uploads/            # 上传/缓存的图片、音频（通过 /api/uploads/... 暴露）
└── outputs/            # 导出/中间产物
```

### 9.3 URL 过期问题

云端返回的"签名临时 URL"（例如火山 TOS）会过期。

**处理方式**:
- 后端尽量将远程资源缓存到 `/api/uploads/...`
- 历史记录保留并标记过期
- UI 提示"已过期/需重生成"

---

## 10. 常见问题

### 10.1 启动问题

| 问题 | 解决方案 |
|------|----------|
| 端口被占用 | 检查 `8001/5174`，或修改启动参数 |
| Python 依赖缺失 | `pip install -r requirements.txt` |
| Node 依赖问题 | 删除 `node_modules` 重新 `npm install` |

### 10.2 生成问题

| 问题 | 原因 | 解决方案 |
|------|------|----------|
| 图片显示"过期/需重生成" | 签名临时 URL 已过期 | 重新生成或上传参考图 |
| 生成失败 400/403 | 参考图 URL 已过期 | 检查配置/服务端日志 |
| 角色外观不一致 | 无参考图 | 先生成元素图片，再生成起始帧 |
| 视频时长固定 6s | 工具限制 | 使用音频先行流程（规划中） |

### 10.3 调试建议

1. **查看 OpenAPI 文档**: `http://localhost:8001/docs`
2. **检查后端日志**: 控制台输出
3. **检查网络请求**: 浏览器开发者工具 Network 面板
4. **验证配置**: `/api/test-connection`

---

## 附录：代码索引

| 功能 | 文件 | 行号/方法 |
|------|------|-----------|
| Pipeline 入口 | `agent_service.py` | `execute_full_pipeline()` L3784 |
| 元素生成 | `agent_service.py` | `generate_all_elements()` L2808 |
| 起始帧生成 | `agent_service.py` | `generate_all_start_frames()` L2970 |
| 视频生成 | `agent_service.py` | `generate_all_videos()` L3314 |
| 视频 Prompt 构建 | `agent_service.py` | `_build_video_prompt_for_shot()` L2712 |
| 角色一致性提示 | `agent_service.py` | `_build_character_consistency_prompt()` L3670 |
| 参考图收集 | `agent_service.py` | `_collect_element_reference_images()` L3738 |
| 音频生成 | `main.py` | `generate_project_audio()` L3297 |
| 项目模型 | `agent/models.py` | `AgentProject` |
| 镜头类型 | `agent/constants.py` | `SHOT_TYPES` |
| 脚本拆解 | `main.py` | `parse_story()` |
| LLM 调用 | `llm_service.py` | - |
| 图像生成 | `image_service.py` | - |
| 视频生成 | `video_service.py` | - |
| TTS 服务 | `tts_service.py` | - |

---

## 相关文档

- [视频制作流程优化.md](视频制作流程优化.md) - 音频先行流程改造详细规划
- [BUILD.md](BUILD.md) - 打包与发布
- [HUOBAO_SUBMODULE_GUIDE.md](HUOBAO_SUBMODULE_GUIDE.md) - huobao-drama 子模块指南
