# AI 视频分镜制作助手 (AI Storyboarder) - 完整开发文档

**版本**: v1.0  
**日期**: 2025-05-20  
**状态**: 待开发  

---

## 📖 第一部分：产品需求文档 (PRD)

### 1. 项目概述
#### 1.1 产品简介
一款面向影视创作者、短视频博主及广告从业者的桌面端应用程序（Windows .exe）。该软件利用多模态大模型技术，能够根据用户上传的一张参考图（首帧）和剧情文本，自动生成连续的、风格统一的后续分镜画面，辅助用户快速完成视频脚本的分镜可视化。

#### 1.2 核心价值
* **一致性保持**：基于首帧图片，保持人物、画风、环境的高度连贯（基于 ComfyUI 工作流中的 IPAdapter/Reference 逻辑）。
* **自动化叙事**：利用 LLM 自动拆解剧情，生成分镜描述。
* **灵活部署**：提供“小白模式”（API 调用）和“极客模式”（本地显卡运行）两种选择。

### 2. 功能需求说明 (Functional Requirements)

#### 2.1 首页与项目管理
* **新建项目**：创建新的分镜工程。
* **历史记录**：查看和加载之前的分镜生成记录（保存为 `.sbproj` 文件）。
* **设置入口**：配置模型路径、API Key、显存策略等全局设置。

#### 2.2 输入模块
* **参考图上传**：
    * 支持拖拽上传首帧/角色参考图。
    * **作用**：作为视觉锚点，控制生成图的角色和风格一致性。
* **剧情/上下文输入**：
    * **文本框**：用户输入一段故事梗概或具体的下一场戏描述（例如：“主角走进房间，发现桌上有一封信”）。
* **参数预设**：
    * **风格选择**：电影感、动漫、写实、水墨等（映射到预设 Prompt）。
    * **分镜数量**：设置一次生成多少张分镜图（默认 4-8 张）。

#### 2.3 剧本与分镜描述生成 (LLM Module)
* **LLM 智能拆解**：
    * 调用 LLM（Qwen/GPT-4o/Claude）将用户的粗略剧情拆解为具体的、带有镜头语言的分镜提示词。
    * **Prompt 模板**：系统内置类似 *"Next Scene: [动作描述]，[镜头语言]，[光影氛围]..."* 的提示词工程。
* **交互式修改**：
    * 用户预览 LLM 生成的文字分镜列表。
    * 支持手动编辑、增加或删除某一段文字描述。

#### 2.4 图像生成引擎 (Core Engine)
需支持两种模式切换：

* **模式 A：API 云端模式 (轻量化)**
    * **原理**：将提示词和参考图发送至云端服务生成。
    * **支持**：RunningHub / 阿里云百炼 (直接复用工作流中的 Qwen API)、Midjourney (需中转)。
    * **优点**：无需高性能显卡，软件体积小。

* **模式 B：本地部署模式 (隐私与高性能)**
    * **原理**：在用户本地运行模型（封装 Python 环境或调用本地 ComfyUI 后端）。
    * **模型**：Qwen-VL-Image, SDXL, 或 Flux.1。
    * **特性**：支持 LoRA 加载（如 `Next Scene LoRA`）、显存自动检测。

#### 2.5 分镜编辑器与展示
* **瀑布流/网格展示**：按顺序展示生成的分镜图。
* **单图操作**：
    * **重绘 (Regenerate)**：对不满意的单张分镜进行重新生成。
    * **下载/保存**：保存单张高清图。
* **拼接导出**：
    * 一键将所有分镜生成一张长图（拼图）。
    * 导出为 PDF 脚本格式（左图右文）。

---

## 🛠️ 第二部分：技术架构设计文档

### 1. 系统架构概览 (System Architecture)

本项目采用 **Electron + Python (FastAPI) + ComfyUI** 的混合架构。

#### 1.1 架构分层
1.  **表现层 (Frontend)**:
    * **技术栈**: Electron + React + TailwindCSS。
    * **职责**: 用户交互、UI渲染、状态管理。
2.  **业务逻辑层 (Middleware)**:
    * **技术栈**: Python (FastAPI)。
    * **职责**: 桥接前端与 AI 引擎，处理 LLM 请求，解析 ComfyUI JSON，管理文件。
3.  **AI 引擎层 (Core Engine)**:
    * **技术栈**: Comfy