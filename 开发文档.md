# AI Storyboarder 开发文档（总览）

本文档面向开发者，基于仓库当前实现梳理：如何启动、配置、扩展后端能力、理解数据落盘与核心工作流。

更新时间：2026-01-15

## 1. 项目形态

- 桌面端：Electron 启动前端 UI，并在本地启动 Python(FastAPI) 后端（`electron/main.js`）。
- 开发模式：Vite 开发服务器（`http://localhost:5173`）+ FastAPI（`http://localhost:8000`）。
- 打包：Electron Builder；后端可用 PyInstaller 打成 `backend-server.exe`（见 `BUILD.md`）。

## 2. 技术栈

- 前端：React + TypeScript + Vite + TailwindCSS + Zustand（路由为 HashRouter）。
- 后端：Python + FastAPI + Uvicorn + httpx/aiohttp（对接 LLM / 图像 / 视频 / TTS）。
- 存储：本地 YAML 文件为主（`backend/services/storage_service.py`），静态文件挂载在 `/api/uploads/...`。

## 3. 快速启动（推荐）

### 3.1 前置要求

- Node.js 18+
- Python 3.9+（建议 3.10+）

### 3.2 一键启动（Windows）

```bash
npm install
npm run start
```

`start.ps1` 会自动检查依赖并分别启动前端与后端。

### 3.3 手动启动（适合调试）

```bash
# 终端 1：后端
npm run python:dev

# 终端 2：前端
npm run dev
```

可访问：
- 前端：`http://localhost:5173`
- 后端：`http://localhost:8000`
- OpenAPI：`http://localhost:8000/docs`

### 3.4 Electron 开发模式

```bash
npm run electron:dev
```

## 4. 配置与 Provider

后端配置文件位于 `backend/data/`，优先级（高 → 低）：

1. `settings.local.yaml`（本机私有，已被 `.gitignore` 忽略）
2. `settings.yaml`（仓库默认模板，可用于团队共享非敏感默认值）

同理，自定义 Provider：

1. `custom_providers.local.yaml`
2. `custom_providers.yaml`

模板文件：
- `backend/data/settings.yaml.example`
- `backend/data/custom_providers.yaml.example`

配置字段（简化说明）：
- `llm/image/storyboard/video`：每类一个模型配置（`provider/apiKey/baseUrl/model/customProvider`）。
- `tts`：支持 `volc/fish/bailian/custom`，并提供 `/api/tts/test` 进行连通性测试。
- `local`：本地 ComfyUI / SD WebUI 地址及显存策略等（前端设置页可配置）。

环境变量（可选）：
- `LLM_API_KEY / IMAGE_API_KEY / STORYBOARD_API_KEY / VIDEO_API_KEY`

## 5. 数据落盘与目录说明

后端所有数据均落在 `backend/data/`：

- `backend/data/projects/`：普通项目（脚本拆解/分镜生成等）
- `backend/data/scripts/`：脚本数据
- `backend/data/images/`、`backend/data/videos/`：历史与索引
- `backend/data/chat/`：聊天与会话记录
- `backend/data/agent_projects/`：Agent 模式项目（更复杂的分镜/资产/音频/视频流水线）
- `backend/data/exports/`：导出任务产物

媒体文件：
- `backend/uploads/`：上传/缓存的图片、音频等（通过 `/api/uploads/...` 暴露给前端）
- `backend/outputs/`：导出/中间产物（具体由导出逻辑决定）

重要说明：云端返回的“签名临时 URL”（例如火山 TOS）会过期。后端会尽量将远程资源缓存到 `/api/uploads/...` 以便长期展示；历史记录会保留并标记过期，UI 会提示“已过期/需重生成”。

## 6. 核心功能（现状）

### 6.1 普通模式（/home）

- 项目管理：创建/加载/更新/删除项目
- 剧本拆解：`/api/parse-story`（LLM 拆解生成镜头提示词）
- 图像生成：`/api/generate`、`/api/generate-image`、`/api/regenerate`、`/api/images/history`
- 分镜编辑：项目内镜头编辑、图片替换、历史版本管理
- 视频生成：`/api/generate-video`、`/api/video-task-status`、`/api/videos/history`
- 导入导出：`/api/export/*`、`/api/import/*`
- 通用上传：`/api/upload`（图片/音频/文档等）

### 6.2 Agent 模式（/agent）

Agent 模式把“创作”拆成可反复迭代的结构化对象，并提供流式生成：

- 项目：`/api/agent/projects/*`
- 元素（角色/场景/道具等）：生成与收藏 `.../elements/*`
- 分镜镜头：起始帧生成/重生成/收藏 `.../shots/*`
- 流式生成：
  - 元素图：`/api/agent/projects/{id}/generate-elements-stream`
  - 起始帧：`/api/agent/projects/{id}/generate-frames-stream`
  - 视频：`/api/agent/projects/{id}/generate-videos-stream`
- 一键流水线：`/api/agent/projects/{id}/execute-pipeline`
- 辅助能力：脚本润色、资产完成度检查、音频一致性检查等（以 `/api/agent/projects/{id}/*` 为主）

## 7. 后端开发要点

### 7.1 入口与服务拆分

- API 入口：`backend/main.py`
- 业务服务：`backend/services/*`
  - `llm_service.py`：LLM 调用
  - `image_service.py`：图像生成（多 provider）
  - `video_service.py`：视频生成（多 provider + 任务轮询）
  - `tts_service.py` / `fish_audio_service.py`：TTS 与 Fish 相关能力
  - `agent_service.py`：Agent 项目与流水线执行
  - `storage_service.py`：统一落盘与配置读取

### 7.2 新增/扩展 Provider

推荐做法：

1. 前端设置页新增 provider 选项（或直接使用“自定义 Provider”能力写入 `custom_providers*.yaml`）。
2. 后端在对应 service 中实现调用分支（通常是 OpenAI-compatible 的 REST 形式）。
3. 用 `/api/test-connection` 与 `/api/tts/test` 做最小可用验证。

## 8. 常见问题（Troubleshooting）

- 端口被占用：检查 `8000/5173`，或修改启动参数。
- 图片显示“过期/需重生成”：说明引用的是签名临时 URL；重新生成或重新上传参考图后会恢复。
- 生成失败 400/403（远端下载失败）：通常是参考图 URL 已过期；后端会尽量过滤过期引用，如仍失败请检查配置/服务端日志。

## 9. 打包与发布

打包流程与注意事项见：`BUILD.md`。

