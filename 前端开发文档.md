# AI Storyboarder 前端开发文档

本文档聚焦前端（React/Vite/Electron）开发：启动调试、目录结构、路由与状态管理、与后端接口对齐的关键点。

更新时间：2026-01-15

## 1. 启动与调试

### 1.1 前置要求

- Node.js 18+

### 1.2 启动方式

```bash
# 安装依赖
npm install

# 启动前端（Vite）
npm run dev
```

前端默认访问：`http://localhost:5173`

> 说明：前端会请求后端 `http://localhost:8000`。如果只启动前端不启动后端，设置加载与生成能力会失败。

### 1.3 Electron 开发模式

```bash
npm run electron:dev
```

Electron 主进程：`electron/main.js`

## 2. 目录结构（前端）

```
src/
  App.tsx                 # 路由入口（HashRouter + KeepAlive）
  pages/                  # 页面级路由组件
  components/             # 通用组件（Layout/Chat 等）
  features/               # 按领域拆分（agent/canvas/editor/project/settings）
  services/api.ts         # 后端 API 封装（axios）
  store/                  # Zustand 状态（settingsStore/projectStore）
  shared/                 # 可复用子模块（例如 fish TTS UI）
public/                   # 静态资源
```

## 3. 路由与页面

路由定义见 `src/App.tsx`：

- 欢迎页：`/`
- 主应用（带侧边栏）：`/home/*`
  - `HomePage`：总入口
  - `ScriptPage`：剧本拆解/提示词
  - `ImagePage`：图像生成与历史
  - `StoryboardPage`：分镜编辑与批量处理
  - `VideoPage`：视频生成与历史
  - `SettingsPage`：模型/Provider/TTS/本地能力配置
  - `ProjectPage`：项目详情
- Agent 模式（独立布局）：`/agent`、`/agent/:projectId`
- Canvas 模式：`/canvas`、`/canvas/:projectId`

为了避免切页丢状态，`/home/script`、`/home/image`、`/home/storyboard`、`/home/video` 采用 KeepAlive（`KeepAliveOutlet`）缓存渲染。

## 4. 状态管理（Zustand）

- 全局设置：`src/store/settingsStore.ts`
  - 负责加载/保存后端设置（启动时 `App` 会调用 `loadFromBackend()`）。
  - 内置 provider 列表（LLM/IMAGE/VIDEO），设置页会基于这些选项渲染。
- 项目数据：`src/store/projectStore.ts`
  - 负责 `/api/projects/*` 的项目 CRUD 与分镜列表映射。

前端开发建议：先确定数据在「后端落盘」还是「前端临时态」，再决定放 store 还是组件内部 state，避免双向不同步。

## 5. 与后端接口对齐（重点）

### 5.1 API 基址

API 封装集中在 `src/services/api.ts`：

- `API_BASE = http://localhost:8000`
- axios `baseURL` 固定为后端端口

### 5.2 `/api/uploads/...` 的媒体 URL

后端会把上传/缓存文件暴露为 `/api/uploads/{category}/{filename}`。前端渲染时需要补全域名：

- 组件内会使用类似 `resolveMediaUrl()` 将 `/api/...` 拼成 `http://localhost:8000/api/...`
- 对于云端签名临时 URL（如火山 TOS），可能会过期；Agent 面板会显示“已过期/需重生成”的占位提示

### 5.3 Agent 流式生成（SSE）

Agent 模式的元素图、起始帧、视频生成支持流式进度（SSE）。前端侧注意点：

- 处理 `generating/complete/failed` 等事件时，更新本地项目状态与 history
- 历史记录里会同时存在：
  - `url`：用于 UI 展示（优先是 `/api/uploads/...`）
  - `source_url`：供模型引用的源 URL（可能是临时 URL）

## 6. UI/样式约定

- TailwindCSS：以 utility class 为主；避免引入额外 CSS 框架。
- 通用布局：`src/components/Layout.tsx`
- 模块内组件优先放 `src/features/<domain>/components/`，避免 `components/` 目录过大。

## 7. 开发时常用命令

```bash
# 类型检查
npx tsc --noEmit

# 构建（验证生产构建）
npm run build
```

## 8. 常见问题（Troubleshooting）

- 只启动前端导致大量 404/网络错误：需要同时启动后端（`npm run python:dev` 或 `npm run start`）。
- Electron 打开白屏：确认 Vite 端口为 5173，或检查 `electron/main.js` 的加载地址。
- 图片显示“过期”：通常是签名 URL 已过期；重新生成或重新上传参考图即可恢复。

